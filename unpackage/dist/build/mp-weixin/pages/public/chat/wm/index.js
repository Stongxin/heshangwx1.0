(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/public/chat/wm/index"],{"150d":function(e,t,s){"use strict";s.r(t);var o=s("6e61"),a=s("3000");for(var n in a)["default"].indexOf(n)<0&&function(e){s.d(t,e,(function(){return a[e]}))}(n);s("36a7");var i=s("828b"),r=Object(i["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],void 0);t["default"]=r.exports},3e3:function(e,t,s){"use strict";s.r(t);var o=s("8ed9"),a=s.n(o);for(var n in o)["default"].indexOf(n)<0&&function(e){s.d(t,e,(function(){return o[e]}))}(n);t["default"]=a.a},"36a7":function(e,t,s){"use strict";var o=s("f5ce"),a=s.n(o);a.a},"6e61":function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return n})),s.d(t,"a",(function(){return o}));var o={shoproNavbar:function(){return s.e("components/shopro-navbar/shopro-navbar").then(s.bind(null,"9733"))},uParse:function(){return Promise.all([s.e("common/vendor"),s.e("node-modules/uview-ui/components/u-parse/u-parse")]).then(s.bind(null,"bc80"))}},a=function(){var e=this,t=e.$createElement,s=(e._self._c,e.selectModel?e.selectModelData.length:null),o=e.selectModel&&s>0?e.__map(e.selectModelData,(function(t,s){var o=e.__get_orig(t),a=s.toString();return{$orig:o,g1:a}})):null,a=e.selectModel?e.selectModelData.length:null;e.$mp.data=Object.assign({},{$root:{g0:s,l0:o,g2:a}})},n=[]},"8ed9":function(e,t,s){"use strict";(function(e){var o=s("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=o(s("7eb4")),n=o(s("ee10")),i=o(s("7ca3")),r=o(s("a0b7")),c=s("8f59"),l=o(s("a25c"));function d(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,o)}return s}e.getStorageSync("sh_token");var u="",h=null,f={components:{},data:function(){return{headTitle:"客服",leaveMessage:{name:"",contact:"",message:""},attachBackground:"",showSendButton:!1,showTool:!1,showLeaveMessage:!1,expressionData:[],scrollIntoFooter:"",config:[],tokenList:[],kefuMessage:"",wrapperHeight:46,ws:{SocketTask:null,Timer:null,ErrorMsg:[],MaxRetryCount:3,CurrentRetryCount:0,socketOpen:!1,pageHideCloseWs:!0,unloadCloseWs:!1},csr:"",sessionId:0,sessionUser:"",kefuMessageFocus:!1,messageList:[],chatRecordPage:1,errorTips:"链接中...",selectModel:!1,selectModelType:{goods:"发送商品",order:"发送订单"},selectModelData:[],writeBottom:0}},computed:function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?d(Object(s),!0).forEach((function(t){(0,i.default)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):d(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({},(0,c.mapGetters)(["userInfo"])),props:{options:null},created:function(){var e,t;u=null!==(e=this.options)&&void 0!==e&&e.fixed_csr?null===(t=this.options)||void 0===t?void 0:t.fixed_csr:u,this.load()},onShow:function(){this.ws.pageHideCloseWs||(this.ws.pageHideCloseWs=!0),this.load()},onHide:function(){this.ws.SocketTask&&this.ws.socketOpen&&this.ws.pageHideCloseWs&&(console.log("微信小程序页面hide主动关闭链接"),e.closeSocket()),e.hideKeyboard()},beforeDestroy:function(){this.ws.SocketTask&&this.ws.socketOpen&&(console.log("页面卸载主动关闭链接"),this.ws.unloadCloseWs=!0,e.closeSocket())},methods:{jump:function(e,t){this.$Router.push({path:e,query:t})},goDetail:function(e){e.number?this.jump("/pages/order/detail",{id:e.id}):this.jump("/pages/goods/detail",{id:e.id})},hideMask:function(){this.showTool&&(this.showTool=!1),this.selectModel&&(this.selectModel=!1),this.writeBottom=0},load:function(){var t=this,s="";try{s=e.getStorageSync("kefu_tourists_token");s||(s="")}catch(o){console.error(o)}e.request({url:t.build_url("initialize"),data:{token:e.getStorageSync("sh_token"),kefu_tourists_token:s,fixed_csr:u},success:function(s){if(1==s.data.code){if(s.data.data.token_list.kefu_tourists_token)try{e.setStorageSync("kefu_tourists_token",s.data.data.token_list.kefu_tourists_token)}catch(o){console.error(o)}h=e.createInnerAudioContext(),h.src=t.build_url("message_prompt");var a="";try{a=e.getStorageSync("kefu_notice")}catch(o){console.log(o)}a==s.data.data.config.announcement&&(s.data.data.config.announcement=""),t.config=s.data.data.config,t.tokenList=s.data.data.token_list,s.data.data.new_msg&&t.new_message_prompt();var n=r.default.https_switch?"https://":"http://",i={};for(var c in r.default.expression)i[c]={src:n+r.default.baseURL+"/assets/addons/kefu/img"+r.default.expression[c].src,title:r.default.expression[c].title};t.expressionData=i,t.attachBackground=t.build_url("res","/img/more.png"),t.connect_socket()}},fail:function(s){e.showModal({title:"温馨提示",content:"在线客服初始化失败,请重试~",showCancel:!1}),t.errorTips="初始化失败"}})},switch_show_tool:function(e){e?(this.showTool=e,this.writeBottom=170,this.scroll_into_footer(200)):(this.showTool=!1,this.writeBottom=0)},close_notice:function(){e.setStorageSync("kefu_notice",this.config.announcement),this.config.announcement=""},select_done:function(e){var t=e.detail.value,s="";for(var o in this.selectModelData[t])s+=o+"="+this.selectModelData[t][o]+"#";this.send_message(s,"goods"==this.selectModel?4:5),this.selectModel=!1,this.switch_show_tool(!1)},show_select_model:function(t){var s=this;if(this.selectModel=t,t){e.showLoading({title:"请稍后..."});var o=this.config.toolbar[t].data_api,a=new RegExp("(^https?://)","i");-1===o.search(a)&&(o=(r.default.https_switch?"https://":"http://")+r.default.baseURL+o),this.selectModelData=[],e.request({url:o,data:{token:e.getStorageSync("sh_token")},success:function(t){1==t.data.code?s.selectModelData=t.data.data.data:e.showModal({title:"温馨提示",content:t.data.msg,showCancel:!1})},fail:function(t){e.showModal({title:"温馨提示",content:"网络请求失败，请重试！",showCancel:!1})},complete:function(t){e.hideLoading()}})}},parseUrl:function(e){var t=new RegExp("(https?://)([0-9a-z.]+)([?0-9a-z&=]+)?(#[0-9-a-z]+)?","g");return e.replace(t,'<a target="_blank" title="$&" class="link" href="$&">$&</a>')},message_img_preview:function(e){this.ws.pageHideCloseWs=!1},preview_img:function(t){this.ws.pageHideCloseWs=!1,e.previewImage({current:t,urls:[t]})},upload_file:function(){var t=this;return(0,n.default)(a.default.mark((function s(){var o,n;return a.default.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return s.next=2,new l.default("writePhotosAlbum").check();case 2:o=s.sent,o&&(n=t,n.ws.pageHideCloseWs=!1,e.chooseImage({success:function(t){var s=t.tempFilePaths;e.showLoading({title:"正在上传..."});var o=e.uploadFile({url:n.build_url("upload"),filePath:s[0],name:"file",formData:{token:e.getStorageSync("sh_token")},success:function(t){e.hideLoading(),n.ws.pageHideCloseWs=!0,t=JSON.parse(t.data),1==t.code?(n.send_message(t.data,1),n.switch_show_tool(!1),n.kefuMessageFocus=!0):e.showModal({title:"温馨提示",content:t.msg,showCancel:!1})},complete:function(t){e.hideLoading()}});o.onProgressUpdate((function(t){e.showLoading({title:t.progress+"%"})}))}}));case 4:case"end":return s.stop()}}),s)})))()},connect_socket:function(){var t=this;this.ws.SocketTask&&this.ws.socketOpen?console.log("无需链接"):(t.ws.SocketTask=e.connectSocket({url:this.build_url("ws"),header:{"content-type":"application/json"},complete:function(e){}}),e.onSocketOpen((function(e){for(var s in console.log("链接已打开"),t.ws.socketOpen=!0,t.ws.CurrentRetryCount=0,t.ws.ErrorMsg)t.ws_send(t.ws.ErrorMsg[s]);t.ws.ErrorMsg=[],t.errorTips="",null!=t.ws.Timer&&clearInterval(t.ws.Timer),t.ws.Timer=setInterval(t.ws_send,28e3)})),e.onSocketMessage((function(e){var s=JSON.parse(e.data);t.domsg(s)})),e.onSocketError((function(e){t.ws.socketOpen=!1,t.errorTips="WebSocket 发生错误!",console.log("链接出错",e)})),e.onSocketClose((function(e){console.log("链接已关闭",e),t.ws.socketOpen=!1,1e3==e.code||1e4==e.code||t.ws.unloadCloseWs||(null!=t.ws.Timer&&clearInterval(t.ws.Timer),t.ws.socketOpen=!1,-1===t.errorTips.indexOf("重连")&&(t.errorTips="网络链接已断开!"),t.ws.MaxRetryCount&&(t.ws.Timer=setInterval(t.retry_websocket,3e3)))})))},retry_websocket:function(){this.ws.CurrentRetryCount<this.ws.MaxRetryCount?(this.ws.CurrentRetryCount++,this.connect_socket(),this.errorTips="重连WebSocket第"+this.ws.CurrentRetryCount+"次"):(null!=this.ws.Timer&&clearInterval(this.ws.Timer),this.errorTips="每隔10秒将再次尝试重连 WebSocket",this.ws.Timer=setInterval(this.connect_socket,1e4))},ws_send:function(t){t||(t={c:"Message",a:"ping"}),this.ws.SocketTask&&this.ws.socketOpen?e.sendSocketMessage({data:JSON.stringify(t)}):(console.log("消息发送出错",t,this.ws.SocketTask,this.ws.socketOpen),this.ws.ErrorMsg.push(t))},send_message:function(t,s){if(""!=t)if(this.ws.SocketTask&&this.ws.socketOpen)if(this.sessionId){if(0==s){t=this.parseUrl(t);var o=t.match(/\[(.+?)\]/g);if(o)for(var a in o){var n=this.find_emoji(o[a]);t=t.replace(n.title,this.build_chat_img(n.src,"","emoji"))}}var i={c:"Message",a:"sendMessage",data:{message:1==s?t.url:t,message_type:s,session_id:this.sessionId,modulename:"index"}};this.ws_send(i);var r=this.messageList[this.messageList.length-1].data,c=r[r.length-1].id+1,l={id:c,sender:"me",message:1==s?t.fullurl:t,message_type:s},d=this.messageList.length-1;this.messageList[d]&&"刚刚"==this.messageList[d].datetime?this.messageList[d].data=this.messageList[d].data.concat(this.format_message([l])):this.messageList=this.messageList.concat({datetime:"刚刚",data:this.format_message([l])}),this.kefuMessage="",this.kefu_message_change(),this.scroll_into_footer(300),this.wrapperHeight=46}else e.showToast({title:"请选择一个会话~",icon:"none"});else e.showToast({title:"网络链接异常，请稍后重试~",icon:"none"});else e.showToast({title:"请输入消息内容",icon:"none"})},find_emoji:function(e){for(var t in this.expressionData)if(this.expressionData[t].title==e)return this.expressionData[t];return!1},build_chat_img:function(e,t){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"emoji";r.default.https_switch;return"emoji"==s?'<img class="emoji" src="'+e+'" />':'<img class="'+s+'" src="'+e+'" />'},leave_message:function(e){"c-name"==e.currentTarget.id?this.leaveMessage.name=e.detail.value:"c-contact"==e.currentTarget.id?this.leaveMessage.contact=e.detail.value:"c-message"==e.currentTarget.id&&(this.leaveMessage.message=e.detail.value)},post_leave_message:function(){if(!this.leaveMessage.contact)return e.showToast({title:"联系方式不能为空哦~",icon:"none"}),!1;var t={c:"Message",a:"leaveMessage",data:this.leaveMessage};this.ws_send(t)},domsg:function(t){var s=this;if("initialize"==t.msgtype){t.data.new_msg&&s.new_message_prompt();var o={c:"Message",a:"userInitialize",data:{fixed_csr:s.fixedCsr}};s.ws_send(o)}else if("user_initialize"==t.msgtype)1==t.code?(t.data.session.user_tourists&&(s.send_message=function(){e.showToast({title:"为保护您的隐私请,请登录后发送消息~",icon:"none"})}),s.csr=t.data.session.csr,s.sessionId=t.data.session.id,s.showLeaveMessage=!1,s.headTitle="客服 "+t.data.session.nickname+" 为您服务"):302==t.code&&(s.csr?e.showToast({title:"当前客服暂时离开,您可以直接发送离线消息~",icon:"none"}):(s.csr="none",s.showLeaveMessage=!0,s.headTitle="当前无客服在线哦~"));else if("show_msg"==t.msgtype)e.showToast({title:t.msg,icon:"none"});else if("leave_message"==t.msgtype)e.showToast({title:t.msg,icon:"none"}),this.leaveMessage={name:"",contact:"",message:""};else if("clear"==t.msgtype){t.msg&&e.showToast({title:t.msg,icon:"none"});s.ws_send({c:"Message",a:"clear"}),s.retry_webSocket=function(){clearInterval(s.ws.Timer)}}else if("offline"==t.msgtype)t.user_id==s.csr&&(this.errorTips="客服离线~");else if("online"==t.msgtype){if("admin"==t.modulename)if(t.user_id==s.csr)this.errorTips="";else if("none"==s.csr){o={c:"Message",a:"userInitialize"};s.ws_send(o)}}else if("csr_change_status"==t.msgtype)s.csr==t.data.csr&&(3!=t.data.csr_status?s.errorTips="客服"+s.get_csr_status(t.data.csr_status)+"~":s.errorTips="");else if("transfer_done"==t.msgtype)s.csr=t.data.csr,s.headTitle="客服 "+t.data.nickname+" 为您服务";else if("new_message"==t.msgtype){if(s.new_message_prompt(),t.data.session_id==s.sessionId){var a=s.messageList.length-1;"刚刚"==s.messageList[a].datetime?s.messageList[a].data=s.messageList[a].data.concat(s.format_message([t.data])):s.messageList=s.messageList.concat({datetime:"刚刚",data:s.format_message([t.data])});var n={c:"Message",a:"readMessage",data:{record_id:t.data.record_id}};s.ws_send(n),s.scroll_into_footer(800)}}else if("chat_record"==t.msgtype){for(var i in s.chatRecordPage=t.data.next_page,t.data.chat_record)t.data.chat_record[i].data=s.format_message(t.data.chat_record[i].data);if(1==t.data.page)s.messageList=t.data.chat_record,s.scroll_into_footer(800);else for(var r=t.data.chat_record.length-1;r>=0;r--)t.data.chat_record[r].data.reverse(),s.messageList.unshift(t.data.chat_record[r])}},get_csr_status:function(e){switch(parseInt(e)){case 0:e="离线";break;case 1:e="繁忙";break;case 2:e="离开";break;case 3:e="在线";break;case 99:e="断链";break;default:e="未知";break}return e},build_url:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ws",t=arguments.length>1?arguments[1]:void 0,s=this,o=r.default.https_switch?"https://":"http://";switch(e){case"ws":var a="&token="+(s.tokenList.kefu_token?s.tokenList.kefu_token:""),n="&kefu_tourists_token="+(s.tokenList.kefu_tourists_token?s.tokenList.kefu_tourists_token:""),i=r.default.baseURL.split(":")[0];return o=1==parseInt(s.config.wss_switch)?"wss://":"ws://",(o+i+":"+s.config.websocket_port+"/?modulename=index"+a+n).replace(/\|/g,"~");case"initialize":return o+r.default.baseURL+"/addons/kefu/index/initialize?modulename=index";case"upload":return o+r.default.baseURL+"/addons/shopro/index/upload";case"message_prompt":return s.config.__CDN__?s.config.__CDN__+"/assets/addons/kefu/audio/message_prompt.wav":o+r.default.baseURL+"/assets/addons/kefu/audio/message_prompt.wav";case"res":return s.config.__CDN__?s.config.__CDN__+"/assets/addons/kefu"+t:o+r.default.baseURL+"/assets/addons/kefu"+t}},new_message_prompt:function(){h?(h.play(),setTimeout((function(){h.stop()}),1e3)):console.error("来信提示音播放失败！")},scroll_into_footer:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this;setTimeout((function(){t.scrollIntoFooter="wrapper_footer"}),e),t.scrollIntoFooter=""},wrapper_scrolltoupper:function(){if(this.sessionId&&"done"!=this.chatRecordPage){var e={c:"Message",a:"chatRecord",data:{session_id:this.sessionId,page:this.chatRecordPage}};this.ws_send(e)}},tap_scroll_view:function(){this.switch_show_tool(!1)},show_tool:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smiley";this.showTool==e?this.switch_show_tool(!1):this.switch_show_tool(e),this.showTool&&this.scroll_into_footer()},textarea_focus:function(e){this.showTool=!1},textarea_input:function(e){this.kefu_message_change()},kefu_message_change:function(){var t=this;this.showSendButton=""!=this.kefuMessage;var s=e.createSelectorQuery().in(this).select(".write");s.fields({size:!0},(function(e){e.height!=t.wrapperHeight&&(t.wrapperHeight=e.height)})).exec()},kefu_message_blur:function(){this.kefuMessageFocus=!1,this.showTool||(this.writeBottom=0)},select_expression:function(e){this.kefuMessage=this.kefuMessage+e,this.kefu_message_change()},format_message:function(e){for(var t in e)if(4==e[t].message_type||5==e[t].message_type){var s=e[t].message.split("#"),o={};for(var a in s){var n=s[a].split("=");"undefined"!=typeof n[1]&&(o[n[0]]=n[1])}e[t].message=o}return e}}};t.default=f}).call(this,s("df3c")["default"])},f5ce:function(e,t,s){}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'pages/public/chat/wm/index-create-component',
    {
        'pages/public/chat/wm/index-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('df3c')['createComponent'](__webpack_require__("150d"))
        })
    },
    [['pages/public/chat/wm/index-create-component']]
]);
